#!/usr/bin/env ruby

require 'keep_up'
require 'bundler'

@local = true

def bundle(command)
  system "bundle #{command} #{'--local' if @local}"
end

def run_or_raise(command)
  puts "Running #{command}"
  success = system command
  raise unless success
end

def bundle_outdated?
  success = bundle 'outdated'
  if success
    puts 'Bundle up to date!'
  else
    puts 'Bundle is outdated!'
  end
  !success
end

def run
  bundle 'install' or raise

  current_lock_file = Bundler.default_lockfile.read

  return unless bundle_outdated?

  bundle 'update' or raise

  new_lock_file = Bundler.default_lockfile.read

  if new_lock_file == current_lock_file
    puts 'Update had no effect!'
  end

  run_or_raise 'bundle exec rake'

  # create branch
  # git status
  # git commit
  #
end

run
